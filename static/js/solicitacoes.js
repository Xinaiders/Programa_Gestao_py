/**
 * JavaScript para tabela de solicita√ß√µes - Vers√£o Limpa
 * Sistema de Gest√£o de Estoque
 */

document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ Inicializando tabela de solicita√ß√µes...');
    
    initSelectAll();
    initAtualizarTabela();
    initImprimir();
    verificarItensEmImpressaoPendente();
    
    console.log('‚úÖ Tabela inicializada com sucesso!');
});

/**
 * Configurar sele√ß√£o de todos os checkboxes
 */
function initSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.solicitacao-checkbox');
    
    if (!selectAllCheckbox || !checkboxes.length) return;
    
    selectAllCheckbox.addEventListener('change', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
    
    // Atualizar checkbox principal quando individuais mudarem
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);
            
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
        });
    });
}


/**
 * Mostrar notifica√ß√£o
 */
function showNotification(message, type = 'info') {
    // Criar elemento de notifica√ß√£o
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    `;
    
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Remover ap√≥s 5 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

/**
 * Adicionar efeitos visuais
 */
function addVisualEffects() {
    // Efeito de hover nas linhas
    const rows = document.querySelectorAll('.table-modern tbody tr');
    rows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(4px)';
            this.style.transition = 'transform 0.2s ease';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(0)';
        });
    });
}

/**
 * Configurar bot√£o de atualizar tabela
 */
function initAtualizarTabela() {
    const btnAtualizar = document.getElementById('btnAtualizarTabela');
    if (!btnAtualizar) return;
    
    btnAtualizar.addEventListener('click', function() {
        atualizarTabela();
    });
}

/**
 * Atualizar tabela com progresso
 */
function atualizarTabela() {
    const btnAtualizar = document.getElementById('btnAtualizarTabela');
    const btnText = document.getElementById('btnText');
    const modal = new bootstrap.Modal(document.getElementById('modalCarregamento'));
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const statusText = document.getElementById('statusText');
    
    // Fun√ß√£o para restaurar estado do bot√£o
    function restaurarBotao() {
        btnAtualizar.disabled = false;
        btnText.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Atualizar Tabela';
    }
    
    // Desabilitar bot√£o
    btnAtualizar.disabled = true;
    btnText.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Atualizando...';
    
    // Mostrar modal
    modal.show();
    
    // Simular progresso
    let progress = 0;
    const interval = setInterval(() => {
        try {
            progress += Math.random() * 15;
            if (progress > 100) progress = 100;
            
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressText.textContent = Math.round(progress) + '%';
            
            // Atualizar status
            if (progress < 20) {
                statusText.textContent = 'Conectando com Google Sheets...';
            } else if (progress < 40) {
                statusText.textContent = 'Lendo dados das Solicita√ß√µes...';
            } else if (progress < 60) {
                statusText.textContent = 'Lendo dados da Matriz...';
            } else if (progress < 80) {
                statusText.textContent = 'Processando dados da matriz...';
            } else if (progress < 95) {
                statusText.textContent = 'Sincronizando informa√ß√µes...';
            } else {
                statusText.textContent = 'Finalizando atualiza√ß√£o...';
            }
            
            if (progress >= 100) {
                clearInterval(interval);
                
                // Restaurar estado do bot√£o
                restaurarBotao();
                
                // Aguardar um pouco antes de redirecionar
                setTimeout(() => {
                    modal.hide();
                    
                    // Redirecionar para a rota de sincroniza√ß√£o
                    window.location.href = '/sincronizar-matriz';
                }, 500);
            }
        } catch (error) {
            console.error('Erro durante atualiza√ß√£o:', error);
            clearInterval(interval);
            restaurarBotao();
            modal.hide();
        }
    }, 200);
}

/**
 * Configurar bot√£o de impress√£o
 */
function initImprimir() {
    const btnImprimir = document.getElementById('btnImprimir');
    if (!btnImprimir) return;
    
    btnImprimir.addEventListener('click', function() {
        imprimirSolicitacoes();
    });
}

/**
 * Fun√ß√£o para abrir formul√°rio de impress√£o
 */
function imprimirSolicitacoes() {
    console.log('üñ®Ô∏è Abrindo formul√°rio de impress√£o...');
    
    // Verificar se h√° checkboxes selecionados
    const checkboxesSelecionados = document.querySelectorAll('.solicitacao-checkbox:checked');
    
    if (checkboxesSelecionados.length === 0) {
        showNotification('Selecione pelo menos uma solicita√ß√£o para imprimir', 'warning');
        return;
    }
    
    // Verificar se h√° itens bloqueados (desabilitados)
    const itensBloqueados = Array.from(checkboxesSelecionados).filter(checkbox => checkbox.disabled);
    
    if (itensBloqueados.length > 0) {
        showNotification(`‚ùå ${itensBloqueados.length} item(ns) selecionado(s) n√£o podem ser impressos. Verifique os itens destacados na tabela.`, 'error');
        return;
    }
    
    // Coletar IDs das solicita√ß√µes selecionadas
    const idsSelecionados = Array.from(checkboxesSelecionados).map(checkbox => checkbox.value);
    console.log(`üìã ${idsSelecionados.length} solicita√ß√µes selecionadas para impress√£o:`, idsSelecionados);
    
    // Criar URL com os IDs selecionados
    const idsParam = idsSelecionados.join(',');
    const url = `/formulario-impressao?ids=${encodeURIComponent(idsParam)}`;
    
    // Mostrar modal de carregamento
    const modal = new bootstrap.Modal(document.getElementById('modalCarregamentoImpressao'));
    const progressBar = document.getElementById('progressBarImpressao');
    const progressText = document.getElementById('progressTextImpressao');
    const statusText = document.getElementById('statusTextImpressao');
    
    modal.show();
    
    // Simular progresso
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 100) progress = 100;
        
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressText.textContent = Math.round(progress) + '%';
        
        // Atualizar status
        if (progress < 20) {
            statusText.textContent = 'Criando romaneio de separa√ß√£o...';
        } else if (progress < 40) {
            statusText.textContent = 'Processando dados das solicita√ß√µes...';
        } else if (progress < 60) {
            statusText.textContent = 'Gerando formul√°rio de impress√£o...';
        } else if (progress < 80) {
            statusText.textContent = 'Preparando para impress√£o...';
        } else if (progress < 95) {
            statusText.textContent = 'Atualizando status para "Em Separa√ß√£o"...';
        } else {
            statusText.textContent = 'Finalizando processamento...';
        }
        
        if (progress >= 100) {
            clearInterval(interval);
        }
    }, 200);
    
    // Fazer requisi√ß√£o para criar o romaneio e obter o HTML
    console.log('üîÑ Fazendo requisi√ß√£o para:', url);
    fetch(url, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        }
    })
    .then(response => {
        console.log('üì° Resposta recebida:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.text();
    })
    .then(html => {
        console.log('üìÑ HTML recebido, tamanho:', html.length, 'caracteres');
        
        // Aguardar um pouco para mostrar o progresso
        setTimeout(() => {
            // Criar uma nova janela tempor√°ria para impress√£o
            const printWindow = window.open('', '_blank', 'width=1200,height=800');
            
            if (!printWindow) {
                modal.hide();
                showNotification('Erro: N√£o foi poss√≠vel abrir janela de impress√£o. Verifique se o bloqueador de pop-ups est√° desabilitado.', 'error');
                return;
            }
            
            console.log('ü™ü Janela de impress√£o criada');
            
            // Escrever o HTML na nova janela
            printWindow.document.write(html);
            printWindow.document.close();
            
            console.log('üìù HTML escrito na janela');
            
            // Aguardar o carregamento e imprimir
            printWindow.onload = function() {
                console.log('üñ®Ô∏è Iniciando impress√£o...');
                printWindow.focus();
                printWindow.print();
                
                // Fechar a janela ap√≥s impress√£o
                setTimeout(() => {
                    console.log('üîí Fechando janela de impress√£o');
                    printWindow.close();
                }, 1000);
            };
            
            // Fechar modal e mostrar sucesso
            modal.hide();
            showNotification(`Romaneio de separa√ß√£o criado com ${idsSelecionados.length} solicita√ß√£o(√µes)`, 'success');
            
            // Mostrar indicador de atualiza√ß√£o ap√≥s impress√£o
            setTimeout(() => {
                console.log('üîÑ Atualizando informa√ß√µes...');
                showNotification('Atualizando informa√ß√µes da tabela...', 'info');
                
                // Mostrar indicador de atualiza√ß√£o
                mostrarIndicadorAtualizacao();
                
                // Recarregar a p√°gina ap√≥s mostrar o indicador
                setTimeout(() => {
                    console.log('üîÑ Recarregando p√°gina para mostrar status atualizados...');
                    window.location.reload();
                }, 1500);
            }, 1000);
        }, 1000);
    })
    .catch(error => {
        console.error('‚ùå Erro ao processar impress√£o:', error);
        modal.hide();
        
        // Remover overlay de loading se existir
        removerIndicadorAtualizacao();
        
        showNotification(`Erro ao processar impress√£o: ${error.message}`, 'error');
    });
}

/**
 * Mostrar indicador de atualiza√ß√£o de informa√ß√µes
 */
function mostrarIndicadorAtualizacao() {
    // Remover overlay existente se houver
    const existingOverlay = document.getElementById('loadingOverlay');
    if (existingOverlay) {
        existingOverlay.remove();
    }
    
    // Criar novo overlay
    const loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'loadingOverlay';
    loadingOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    `;
    
    loadingOverlay.innerHTML = `
        <div style="background: white; padding: 2rem; border-radius: 10px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <h5 class="text-primary mb-2">Atualizando Informa√ß√µes</h5>
            <p class="text-muted mb-0">Atualizando status das solicita√ß√µes...</p>
        </div>
    `;
    
    document.body.appendChild(loadingOverlay);
    return loadingOverlay;
}

/**
 * Remover indicador de atualiza√ß√£o
 */
function removerIndicadorAtualizacao() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.remove();
    }
}

/**
 * Alterar status das solicita√ß√µes selecionadas para "Em Separa√ß√£o" ap√≥s impress√£o
 */
function alterarStatusAposImpressao(idsSelecionados) {
    console.log('üîÑ Alterando status das solicita√ß√µes selecionadas para "Em Separa√ß√£o"...');
    console.log('üìã IDs selecionados:', idsSelecionados);
    
    fetch('/alterar-status-impressao', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({
            ids_selecionados: idsSelecionados
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`‚úÖ ${data.message}`);
            showNotification(`Status alterado: ${data.message}`, 'success');
            
            // Recarregar a p√°gina para mostrar os novos status
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            console.error('‚ùå Erro ao alterar status:', data.message);
            showNotification(`Erro: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('‚ùå Erro na requisi√ß√£o:', error);
        showNotification('Erro ao alterar status das solicita√ß√µes', 'error');
    });
}

/**
 * Verificar itens que j√° est√£o em impress√£o pendente ou com status "Em Separa√ß√£o"
 */
async function verificarItensEmImpressaoPendente() {
    try {
        console.log('üîç Verificando itens em impress√£o pendente e status "Em Separa√ß√£o"...');
        
        const checkboxes = document.querySelectorAll('.solicitacao-checkbox');
        const ids = Array.from(checkboxes).map(cb => cb.value);
        
        console.log('üìã IDs dos checkboxes encontrados:', ids);
        
        if (ids.length === 0) return;
        
        const response = await fetch('/verificar-itens-impressao', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            },
            body: JSON.stringify({ ids: ids })
        });
        
        const data = await response.json();
        
        console.log('üì° Resposta da API:', data);
        
        if (data.success) {
            let totalBloqueados = 0;
            
            // Verificar itens em impress√£o pendente
            if (data.itens_em_impressao && data.itens_em_impressao.length > 0) {
                console.log(`‚ö†Ô∏è ${data.itens_em_impressao.length} itens j√° est√£o em impress√£o pendente`);
                totalBloqueados += data.itens_em_impressao.length;
                
                data.itens_em_impressao.forEach(id => {
                    const checkbox = document.querySelector(`input[value="${id}"]`);
                    if (checkbox) {
                        checkbox.disabled = true;
                        checkbox.title = 'Este item j√° est√° em impress√£o pendente';
                        
                        // Adicionar classe visual
                        const row = checkbox.closest('tr');
                        if (row) {
                            row.classList.add('table-warning');
                            row.title = 'Item j√° est√° em impress√£o pendente';
                        }
                    }
                });
            }
            
            // Verificar itens com status "Em Separa√ß√£o"
            if (data.itens_em_separacao && data.itens_em_separacao.length > 0) {
                console.log(`‚ö†Ô∏è ${data.itens_em_separacao.length} itens j√° est√£o com status "Em Separa√ß√£o"`);
                totalBloqueados += data.itens_em_separacao.length;
                
                data.itens_em_separacao.forEach(id => {
                    console.log(`üîí Desabilitando checkbox para ID: ${id}`);
                    const checkbox = document.querySelector(`input[value="${id}"]`);
                    if (checkbox) {
                        checkbox.disabled = true;
                        checkbox.title = 'Este item j√° est√° com status "Em Separa√ß√£o"';
                        console.log(`‚úÖ Checkbox ${id} desabilitado`);
                        
                        // Adicionar classe visual diferente
                        const row = checkbox.closest('tr');
                        if (row) {
                            row.classList.add('table-info');
                            row.title = 'Item j√° est√° com status "Em Separa√ß√£o"';
                            console.log(`‚úÖ Linha destacada para ID: ${id}`);
                        }
                    } else {
                        console.log(`‚ùå Checkbox n√£o encontrado para ID: ${id}`);
                    }
                });
            }
            
            // Mostrar aviso se houver itens bloqueados
            if (totalBloqueados > 0) {
                let mensagem = `‚ö†Ô∏è ${totalBloqueados} item(ns) n√£o podem ser impressos: `;
                if (data.itens_em_impressao && data.itens_em_impressao.length > 0) {
                    mensagem += `${data.itens_em_impressao.length} em impress√£o pendente`;
                }
                if (data.itens_em_separacao && data.itens_em_separacao.length > 0) {
                    if (data.itens_em_impressao && data.itens_em_impressao.length > 0) {
                        mensagem += ', ';
                    }
                    mensagem += `${data.itens_em_separacao.length} com status "Em Separa√ß√£o"`;
                }
                
                showNotification(mensagem, 'warning');
            }
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao verificar itens em impress√£o pendente:', error);
    }
}

// Inicializar efeitos visuais
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(addVisualEffects, 100);
});