<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}Sistema de Gest√£o de Estoque{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    {% block styles %}{% endblock %}
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-warehouse me-2"></i>
                Gest√£o de Estoque
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="fas fa-home me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('solicitacoes') }}">
                            <i class="fas fa-clipboard-list me-1"></i>Solicita√ß√µes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('controle_impressoes') }}">
                            <i class="fas fa-clipboard-list me-1"></i>Controle de Romaneios
                        </a>
                    </li>
                    {% if current_user.is_admin %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logs') }}">
                            <i class="fas fa-file-alt me-1"></i>Logs
                        </a>
                    </li>
                    {% endif %}
                    {% if current_user.is_admin %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('listar_usuarios') }}">
                            <i class="fas fa-users me-1"></i>Usu√°rios
                        </a>
                    </li>
                    {% endif %}
                </ul>
                
                <!-- Bot√£o For√ßar Atualiza√ß√£o -->
                <div class="navbar-nav me-3">
                    <button type="button" class="btn btn-sm btn-warning" 
                            id="btnInvalidarCacheGlobal"
                            data-bs-toggle="tooltip" data-bs-placement="bottom" 
                            title="For√ßar atualiza√ß√£o dos dados (use quando mudar status manualmente)">
                        <i class="fas fa-refresh me-1"></i>
                        For√ßar Atualiza√ß√£o
                    </button>
                </div>
                
                <!-- Bot√£o Toggle Tema -->
                <div class="navbar-nav me-2">
                    <button type="button" class="btn btn-sm btn-outline-light" 
                            id="btnToggleTheme"
                            data-bs-toggle="tooltip" data-bs-placement="bottom" 
                            title="Alternar entre tema claro e escuro">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                </div>
                
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="btnUserMenu" role="button">
                            <i class="fas fa-user me-1"></i>{{ current_user.username }}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- Modal Menu do Usu√°rio -->
    <div class="modal fade" id="modalUserMenu" tabindex="-1" aria-labelledby="modalUserMenuLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 350px;">
            <div class="modal-content" style="border-radius: 15px; overflow: hidden; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.15);">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem 1.5rem 1.5rem 1.5rem;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                        <h5 class="modal-title text-white" id="modalUserMenuLabel" style="margin: 0; font-weight: 600; font-size: 1.25rem;">
                            <i class="fas fa-user-circle me-2"></i>{{ current_user.username }}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar" style="background: var(--bg-secondary); border-radius: 50%; padding: 0; opacity: 1; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; border: 2px solid rgba(255,255,255,0.8); box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <span style="color: var(--text-primary); font-size: 1.5rem; font-weight: bold; line-height: 1;">√ó</span>
                        </button>
                    </div>
                    <p class="text-white mb-0" style="opacity: 0.9; font-size: 0.875rem;">
                        <i class="fas fa-shield-alt me-1"></i>Administrador
                    </p>
                </div>
                <div class="modal-body p-0">
                    <div style="padding: 1rem 0;">
                        {% if current_user.is_admin %}
                        <a href="{{ url_for('testar_email_erro') }}" class="user-menu-item" style="display: flex; align-items: center; padding: 1rem 1.5rem; text-decoration: none; color: var(--text-primary); transition: all 0.3s ease; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 45px; height: 45px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                                <i class="fas fa-bug text-white"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Testar E-mail Erro</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Simular erro para teste</div>
                            </div>
                            <i class="fas fa-chevron-right text-muted ms-auto"></i>
                        </a>
                        {% endif %}
                        <a href="{{ url_for('alterar_senha') }}" class="user-menu-item" style="display: flex; align-items: center; padding: 1rem 1.5rem; text-decoration: none; color: var(--text-primary); transition: all 0.3s ease; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 45px; height: 45px; background: linear-gradient(135deg, #ffd700 0%, #ffb700 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                                <i class="fas fa-key text-white"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Alterar Senha</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">Modificar minha senha</div>
                            </div>
                            <i class="fas fa-chevron-right text-muted ms-auto"></i>
                        </a>
                        <a href="{{ url_for('logout') }}" class="user-menu-item" style="display: flex; align-items: center; padding: 1rem 1.5rem; text-decoration: none; color: #dc3545; transition: all 0.3s ease; background: rgba(220, 53, 69, 0.1);">
                            <div style="width: 45px; height: 45px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                                <i class="fas fa-sign-out-alt text-white"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #dc3545; margin-bottom: 0.25rem;">Sair da Conta</div>
                                <div style="font-size: 0.85rem; color: #c33;">Finalizar sess√£o atual</div>
                            </div>
                            <i class="fas fa-chevron-right ms-auto" style="color: #dc3545;"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Progresso - For√ßar Atualiza√ß√£o -->
    <div class="modal fade" id="modalProgressoCache" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="mb-4">
                        <div class="spinner-border text-warning mb-3" role="status" style="width: 4rem; height: 4rem;">
                            <span class="visually-hidden">Atualizando...</span>
                        </div>
                        <h5 class="mb-3">For√ßando Atualiza√ß√£o</h5>
                        <p class="text-muted" id="statusCacheProgresso">Preparando atualiza√ß√£o...</p>
                    </div>
                    
                    <!-- Barra de Progresso -->
                    <div class="mb-3">
                        <div class="progress" style="height: 25px; border-radius: 15px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                                 role="progressbar" 
                                 id="barraProgressoCache"
                                 style="width: 0%">
                                <span id="percentualProgressoCache">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Log de Atividades -->
                    <div class="log-container bg-light p-3 rounded text-start" style="max-height: 150px; overflow-y: auto; font-size: 0.85rem; background-color: var(--bg-secondary) !important; color: var(--text-primary) !important;">
                        <small class="text-muted" id="logAtividadesCache" style="color: var(--text-secondary) !important;">
                            <div>‚è≥ Preparando atualiza√ß√£o de cache...</div>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- Script para bot√£o For√ßar Atualiza√ß√£o Global -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const btnInvalidarCacheGlobal = document.getElementById('btnInvalidarCacheGlobal');
            
            if (btnInvalidarCacheGlobal) {
                btnInvalidarCacheGlobal.addEventListener('click', function() {
                    const btn = this;
                    const originalText = btn.innerHTML;
                    
                    // Mostrar modal de progresso
                    const modal = new bootstrap.Modal(document.getElementById('modalProgressoCache'));
                    
                    // Resetar barra para 0%
                    document.getElementById('barraProgressoCache').style.width = '0%';
                    document.getElementById('percentualProgressoCache').textContent = '0%';
                    document.getElementById('logAtividadesCache').innerHTML = '';
                    
                    modal.show();
                    
                    // Fun√ß√£o para atualizar progresso
                    function atualizarProgressoCache(percentual, status, log) {
                        document.getElementById('barraProgressoCache').style.width = percentual + '%';
                        document.getElementById('percentualProgressoCache').textContent = percentual + '%';
                        document.getElementById('statusCacheProgresso').textContent = status;
                        
                        if (log) {
                            const logContainer = document.getElementById('logAtividadesCache');
                            const div = document.createElement('div');
                            div.textContent = log;
                            logContainer.appendChild(div);
                            logContainer.scrollTop = logContainer.scrollHeight;
                        }
                    }
                    
                    // Aguardar modal aparecer
                    setTimeout(() => {
                        // Iniciar progresso em 0%
                        atualizarProgressoCache(0, 'Preparando...', '‚è≥ Iniciando processo de atualiza√ß√£o...');
                    }, 100);
                    
                    // Come√ßar progresso gradual ap√≥s 200ms
                    setTimeout(() => {
                        var progresso = 0;
                        var contadorLog = 0;
                    
                        const intervaloProgresso = setInterval(() => {
                            if (progresso < 90) {
                                progresso += 0.8; // Aumentar um pouco mais r√°pido
                                
                                // Atualizar barra sempre
                                document.getElementById('barraProgressoCache').style.width = progresso + '%';
                                document.getElementById('percentualProgressoCache').textContent = Math.round(progresso) + '%';
                                
                                // Adicionar log de progresso em momentos espec√≠ficos
                                if (contadorLog === 0 && progresso >= 5) {
                                    atualizarProgressoCache(progresso, 'Conectando...', 'üì° Conectando com Google Sheets...');
                                    contadorLog = 1;
                                } else if (progresso >= 15 && contadorLog === 1) {
                                    atualizarProgressoCache(progresso, 'Atualizando...', 'üìä Atualizando dados do cache...');
                                    contadorLog = 2;
                                } else if (progresso >= 30 && contadorLog === 2) {
                                    atualizarProgressoCache(progresso, 'Processando...', 'üîÑ Limpando cache antigo...');
                                    contadorLog = 3;
                                } else if (progresso >= 45 && contadorLog === 3) {
                                    atualizarProgressoCache(progresso, 'Salvando...', 'üíæ Salvando novo cache...');
                                    contadorLog = 4;
                                } else if (progresso >= 60 && contadorLog === 4) {
                                    atualizarProgressoCache(progresso, 'Finalizando...', '‚è≥ Aguardando resposta do servidor...');
                                    contadorLog = 5;
                                } else if (contadorLog === 5 && progresso >= 65) {
                                    document.getElementById('statusCacheProgresso').textContent = 'Aguardando servidor...';
                                    contadorLog = 6;
                                }
                            }
                        }, 100);
                        
                        // Guardar intervalo no escopo global
                        window.intervaloProgressoCache = intervaloProgresso;
                    }, 200);
                    
                    // Desabilitar bot√£o
                    btn.disabled = true;
                    
                    fetch('/api/invalidar-cache-sheets', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => {
                        if (window.intervaloProgressoCache) {
                            clearInterval(window.intervaloProgressoCache);
                        }
                        
                        atualizarProgressoCache(90, 'Recebendo dados...', '‚úÖ Dados recebidos do servidor');
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Aguardar um pouco antes de completar
                            setTimeout(() => {
                                atualizarProgressoCache(95, 'Processando...', '‚úÖ Cache atualizado com sucesso!');
                                
                                setTimeout(() => {
                                    atualizarProgressoCache(100, 'Conclu√≠do!', 'üîÑ Recarregando p√°gina...');
                                    
                                    // Recarregar a p√°gina ap√≥s 500ms
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 500);
                                }, 200);
                            }, 200);
                        } else {
                            throw new Error(data.message || 'Erro ao invalidar cache');
                        }
                    })
                    .catch(error => {
                        if (window.intervaloProgressoCache) {
                            clearInterval(window.intervaloProgressoCache);
                        }
                        console.error('Erro:', error);
                        atualizarProgressoCache(0, 'Erro ao atualizar', '‚ùå Erro: ' + error.message);
                        
                        // Fechar modal ap√≥s 2 segundos
                        setTimeout(() => {
                            modal.hide();
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }, 2000);
                    });
                });
                
                // Inicializar tooltips
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
            
            // Modal do menu do usu√°rio
            const btnUserMenu = document.getElementById('btnUserMenu');
            if (btnUserMenu) {
                btnUserMenu.addEventListener('click', function(e) {
                    e.preventDefault();
                    const modal = new bootstrap.Modal(document.getElementById('modalUserMenu'));
                    modal.show();
                });
            }
        });
        
        // Sistema de timeout de sess√£o - 2 horas de inatividade
        let inactivityWarningTimer;
        let inactivityLogoutTimer;
        const SESSION_TIMEOUT_MS = 2 * 60 * 60 * 1000; // 2 horas em milissegundos
        const WARNING_TIME_MS = 5 * 60 * 1000; // Avisar 5 minutos antes (1h55min)
        
        function resetInactivityTimer() {
            // Limpar timers anteriores
            clearTimeout(inactivityWarningTimer);
            clearTimeout(inactivityLogoutTimer);
            
            // Avisar 5 minutos antes de expirar (ap√≥s 1h55min de inatividade)
            inactivityWarningTimer = setTimeout(() => {
                if (confirm('‚ö†Ô∏è Voc√™ ficou inativo por 1h55min.\n\nSua sess√£o expirar√° automaticamente em 5 minutos por seguran√ßa.\n\nDeseja continuar usando o sistema?')) {
                    // Fazer requisi√ß√£o para manter sess√£o ativa
                    const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
                    fetch('/keep-alive', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('‚úÖ Sess√£o mantida ativa');
                            resetInactivityTimer(); // Reiniciar timer
                        } else {
                            throw new Error('Falha ao manter sess√£o');
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Erro ao manter sess√£o:', error);
                        alert('‚ö†Ô∏è N√£o foi poss√≠vel manter sua sess√£o ativa. Voc√™ ser√° redirecionado para o login.');
                        window.location.href = '/logout';
                    });
                } else {
                    // Usu√°rio escolheu n√£o continuar - fazer logout
                    window.location.href = '/logout';
                }
            }, SESSION_TIMEOUT_MS - WARNING_TIME_MS);
            
            // Logout autom√°tico ap√≥s exatamente 2 horas de inatividade
            inactivityLogoutTimer = setTimeout(() => {
                alert('‚è∞ Sua sess√£o expirou devido √† inatividade (2 horas).\n\nVoc√™ ser√° redirecionado para a tela de login por seguran√ßa.');
                window.location.href = '/logout';
            }, SESSION_TIMEOUT_MS);
        }
        
        // Detectar atividade do usu√°rio (clique, movimento do mouse, teclas, scroll, etc.)
        const activityEvents = ['mousedown', 'mousemove', 'keypress', 'keydown', 'scroll', 'touchstart', 'click', 'focus'];
        let activityTimeout;
        activityEvents.forEach(event => {
            document.addEventListener(event, () => {
                // Debounce: resetar timer apenas ap√≥s 60 segundos de atividade cont√≠nua
                clearTimeout(activityTimeout);
                activityTimeout = setTimeout(() => {
                    resetInactivityTimer();
                }, 60000); // Reset apenas a cada minuto de atividade
            }, true);
        });
        
        // Iniciar timer quando a p√°gina carregar
        if (document.getElementById('btnUserMenu')) {
            resetInactivityTimer();
        }
        
        // Sistema de Tema Escuro/Claro
        (function() {
            // Fun√ß√£o para aplicar o tema
            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                
                // Atualizar √≠cone do bot√£o
                const themeIcon = document.getElementById('themeIcon');
                if (themeIcon) {
                    if (theme === 'dark') {
                        themeIcon.classList.remove('fa-moon');
                        themeIcon.classList.add('fa-sun');
                    } else {
                        themeIcon.classList.remove('fa-sun');
                        themeIcon.classList.add('fa-moon');
                    }
                }
            }
            
            // Carregar tema salvo ou usar padr√£o (claro)
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            
            // Bot√£o toggle tema
            const btnToggleTheme = document.getElementById('btnToggleTheme');
            if (btnToggleTheme) {
                btnToggleTheme.addEventListener('click', function() {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    applyTheme(newTheme);
                });
            }
        })();
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
