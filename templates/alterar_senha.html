{% extends "base.html" %}

{% block title %}Alterar Senha - Sistema de Gest√£o de Estoque{% endblock %}

{% block styles %}
<style>
    .change-password-container {
        max-width: 500px;
        margin: 3rem auto;
    }
    
    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px 10px 0 0 !important;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .password-requirements {
        background: #f8f9fa;
        border-left: 4px solid #28a745;
        padding: 1rem;
        border-radius: 5px;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="change-password-container">
        <div class="card">
            <div class="card-header text-center py-4">
                <i class="fas fa-key fa-3x mb-3"></i>
                <h4 class="mb-0">Alterar Senha</h4>
            </div>
            
            <div class="card-body p-4">
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>{{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <form method="POST" action="{{ url_for('alterar_senha') }}" id="changePasswordForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    
                    <div class="mb-3">
                        <label for="current_password" class="form-label">
                            <i class="fas fa-lock me-2"></i>Senha Atual
                        </label>
                        <input type="password" 
                               class="form-control" 
                               id="current_password" 
                               name="current_password" 
                               required
                               placeholder="Digite sua senha atual">
                    </div>
                    
                    <div class="mb-3">
                        <label for="new_password" class="form-label">
                            <i class="fas fa-key me-2"></i>Nova Senha
                        </label>
                        <input type="password" 
                               class="form-control" 
                               id="new_password" 
                               name="new_password" 
                               required
                               placeholder="Digite a nova senha"
                               minlength="6">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            M√≠nimo de 6 caracteres
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="confirm_password" class="form-label">
                            <i class="fas fa-check me-2"></i>Confirmar Nova Senha
                        </label>
                        <input type="password" 
                               class="form-control" 
                               id="confirm_password" 
                               name="confirm_password" 
                               required
                               placeholder="Digite a nova senha novamente">
                        <div id="passwordMatch" class="form-text"></div>
                    </div>
                    
                    <div class="password-requirements">
                        <small class="text-muted">
                            <strong>Requisitos da senha:</strong>
                            <ul class="mb-0 mt-2">
                                <li>M√≠nimo de 6 caracteres</li>
                                <li>N√£o pode ser igual √† senha atual</li>
                            </ul>
                        </small>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="fas fa-save me-2"></i>Alterar Senha
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ P√°gina de alterar senha carregada');
    
    const form = document.getElementById('changePasswordForm');
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const passwordMatch = document.getElementById('passwordMatch');
    const submitBtn = document.getElementById('submitBtn');
    
    // Validar se as senhas coincidem (apenas visual)
    function validatePasswords() {
        const newPass = newPassword.value;
        const confirmPass = confirmPassword.value;
        
        if (confirmPass.length > 0) {
            if (newPass === confirmPass) {
                passwordMatch.innerHTML = '<i class="fas fa-check-circle text-success me-1"></i>As senhas coincidem';
                passwordMatch.className = 'form-text text-success';
            } else {
                passwordMatch.innerHTML = '<i class="fas fa-exclamation-triangle text-danger me-1"></i>As senhas n√£o coincidem';
                passwordMatch.className = 'form-text text-danger';
            }
        } else {
            passwordMatch.innerHTML = '';
        }
    }
    
    newPassword.addEventListener('input', validatePasswords);
    confirmPassword.addEventListener('input', validatePasswords);
    
    // Adicionar listener no bot√£o para debug e for√ßar submit
    if (form && submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è Bot√£o clicado!');
            console.log('üìã Campos preenchidos:', {
                currentPassword: !!document.getElementById('current_password').value,
                newPassword: !!document.getElementById('new_password').value,
                confirmPassword: !!document.getElementById('confirm_password').value
            });
            
            // Mostrar loading
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Alterando...';
            submitBtn.disabled = true;
            
            // For√ßar submit do formul√°rio manualmente
            console.log('üì§ Enviando formul√°rio...');
            form.submit();
        });
        
        // Listener adicional de submit do formul√°rio
        form.addEventListener('submit', function(e) {
            console.log('üîÑ Formul√°rio submit disparado!');
        });
    } else {
        console.error('‚ùå Formul√°rio ou bot√£o n√£o encontrado!', {form: !!form, submitBtn: !!submitBtn});
    }
});
</script>
{% endblock %}

